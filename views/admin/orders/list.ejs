<%- include('../../partials/admin_head', { pageTitle: 'Order Management' }) %>

<style>
  /* In case your Bootstrap theme is missing some badge variants */
  .badge { font-weight: 600; }
  .badge-light { background: #f8f9fa; color: #212529; }
  .badge-dark { background: #343a40; color: #fff; }
  .badge-secondary { background: #6c757d; color: #fff; }
  .badge-warning { background: #ffc107; color: #212529; }
  .badge-primary { background: #007bff; color: #fff; }
  .badge-success { background: #28a745; color: #fff; }
  .badge-danger { background: #dc3545; color: #fff; }
  .badge-info { background: #17a2b8; color: #fff; }
</style>

<div class="container mt-4">
  <h3>Orders</h3>

  <table class="table table-striped table-bordered mt-3">
    <thead class="thead-dark">
      <tr>
        <th>Order ID</th>
        <th>Customer</th>
        <th>Status</th>
        <th>Payment</th>
        <th>Total</th>
        <th>Placed At</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% if (orders && orders.length) { %>
        <% orders.forEach(function(o){ 
             // ---- status (robust across shapes) ----
             var sRaw = String(o.orderStatus || o.status || '').toLowerCase();
             var statusMap = {
               'pending':          {label: 'Pending', class: 'badge-secondary'},
               'processing':       {label: 'Processing', class: 'badge-warning'},
               'shipped':          {label: 'Shipped', class: 'badge-primary'},
               'delivered':        {label: 'Delivered', class: 'badge-success'},
               'cancelled':        {label: 'Cancelled', class: 'badge-danger'},
               'return_requested': {label: 'Return Requested', class: 'badge-info'},
               'returning':        {label: 'Returning', class: 'badge-info'},
               'returned':         {label: 'Returned', class: 'badge-dark'}
             };
             var st = statusMap[sRaw] || { label: (o.orderStatus || o.status || '-'), class: 'badge-light' };

             // ---- payment ----
             var pay = o.payment || {};
             var payMethod = pay.method || o.paymentMethod || '-';
             var payStatus = pay.paymentStatus || o.paymentStatus || '-';

             // ---- totals & dates ----
             var total = (o.grandTotal != null) ? o.grandTotal
                       : (o.finalAmount != null) ? o.finalAmount
                       : (o.amount != null) ? o.amount
                       : (o.subtotal != null) ? o.subtotal
                       : 0;

             var placed = o.placedAt || o.createdAt;

             // ---- customer display (uses populate) ----
             var customer = '-';
             if (o.userId) {
               if (typeof o.userId === 'object') {
                 customer = o.userId.name || o.userId.email || String(o.userId._id || '');
               } else {
                 customer = String(o.userId);
               }
             }
        %>
          <tr>
            <td><%= o.orderId || o._id %></td>
            <td><%= customer %></td>
            <td><span class="badge <%= st.class %>"><%= st.label %></span></td>
            <td>
              <%= payMethod %><br>
              <small><%= payStatus %></small>
            </td>
            <td>â‚¹<%= Number(total || 0).toLocaleString('en-IN') %></td>
            <td><%= placed ? new Date(placed).toLocaleString() : '-' %></td>
            <td>
              <a href="/admin/orders/<%= o._id %>" class="btn btn-sm btn-primary">View</a>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr><td colspan="7" class="text-center">No orders found</td></tr>
      <% } %>
    </tbody>
  </table>
</div>

<%- include('../../partials/admin_footer') %>
