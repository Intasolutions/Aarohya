<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Invoice – <%= norm.meta.orderId %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/public/img/core-img/favicon.ico" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{--ink:#212529;--muted:#868e96;--ring:#e9ecef;--brand:#b197fc}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;color:#212529;margin:0;background:#fff}
    .inv-wrap{max-width:900px;margin:24px auto;padding:0 16px}
    .inv-head{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:40px}
    .brand strong{font-size:22px}
    .meta{color:var(--muted);font-size:14px}
    .section{border:1px solid var(--ring);border-radius:12px;margin-top:16px}
    .section-hd{padding:12px 14px;border-bottom:1px solid var(--ring);font-weight:700;background:#fafbfc;border-radius:12px 12px 0 0}
    .section-bd{padding:12px 14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--ring);text-align:left;vertical-align:top}
    th{background:#fafbfc}
    .sum{display:flex;justify-content:flex-end}
    .sum table{width:auto}
    .sum td{padding:6px 12px}
    .tot{border-top:2px solid var(--ring);font-weight:700}
    .top-actions{display:flex;gap:8px;margin-top:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);border-radius:999px;padding:8px 12px;text-decoration:none;color:#343a40}
    .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .kv{display:grid;grid-template-columns:150px 1fr;gap:6px 12px}
    code{background:#f8f9fa;border:1px solid var(--ring);padding:2px 6px;border-radius:6px}
    @media print {
      .no-print{display:none !important}
      body{background:#fff}
      .section{page-break-inside:avoid}
    }
  </style>
</head>
<body>
  <div class="inv-wrap">
    <% const raw = order || {}; %>
    <% const invoiceDate = raw.invoiceDate || norm.meta.createdAt; %>
    <% const A = norm.address || {}; %>

    <!-- Header -->
    <div class="inv-head">
      <div class="brand">
        <img src="/public/img/core-img/logo.png" alt="Logo">
        <div>
          <strong><%= (company && company.name) || 'Store' %></strong><br>
          <span class="muted"><%= (company && company.address) || '' %></span><br>
          <span class="muted">Email: <%= (company && company.email) || '' %> • Phone: <%= (company && company.phone) || '' %></span><br>
          <% if (company && company.gstin) { %><span class="muted">GSTIN: <%= company.gstin %></span><% } %>
        </div>
      </div>
      <div class="meta">
        <div><strong>Invoice</strong></div>
        <div># <%= norm.meta.orderId %></div>
        <div>Date: <%= invoiceDate ? new Date(invoiceDate).toLocaleDateString() : '-' %></div>
        <div>Status: <%= norm.meta.status %></div>
        <div>Payment: <%= norm.meta.paymentMethod %> • <%= norm.meta.paymentStatus %></div>
      </div>
    </div>

    <!-- Actions -->
    <div class="top-actions no-print">
      <a class="btn" href="/orders/<%= order._id %>"><i class="fa fa-arrow-left"></i> Back</a>
      <a class="btn btn-primary" href="#" onclick="window.print()"><i class="fa fa-print"></i> Print</a>
    </div>

    <!-- Addresses -->
    <div class="section">
      <div class="section-hd">Addresses</div>
      <div class="section-bd grid">
        <!-- Bill To -->
        <div>
          <div style="font-weight:700;margin-bottom:6px">Bill To</div>
          <div><strong><%= (user && user.name) || A.name || '-' %></strong></div>
          <div class="muted">
            <%= [A.apartment, A.building, A.street].filter(Boolean).join(', ') %><br>
            <%= [A.city, A.state, A.zip].filter(Boolean).join(', ') %><br>
            <%= A.country || '' %><br>
            <%= [A.phone, A.altPhone].filter(Boolean).length ? ('Phone: ' + [A.phone, A.altPhone].filter(Boolean).join(' / ')) : '' %>
          </div>
        </div>

        <!-- Ship To -->
        <div>
          <div style="font-weight:700;margin-bottom:6px">Ship To</div>
          <div><strong><%= A.name || '-' %></strong></div>
          <div class="muted">
            <%= [A.apartment, A.building, A.street].filter(Boolean).join(', ') %><br>
            <%= [A.city, A.state, A.zip].filter(Boolean).join(', ') %><br>
            <%= A.country || '' %><br>
            <%= [A.phone, A.altPhone].filter(Boolean).length ? ('Phone: ' + [A.phone, A.altPhone].filter(Boolean).join(' / ')) : '' %>
          </div>
          <% if (raw.shippingProvider) { %>
            <div class="muted">Provider: <%= raw.shippingProvider %></div>
          <% } %>
          <% if (raw.trackingNumber) { %>
            <div class="muted">Tracking: <%= raw.trackingNumber %>
              <% if (raw.trackingUrl) { %> • <a href="<%= raw.trackingUrl %>" target="_blank">Track</a><% } %>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Payment Details -->
    <div class="section">
      <div class="section-hd">Payment Details</div>
      <div class="section-bd kv">
        <div>Method</div><div><%= norm.meta.paymentMethod %></div>
        <div>Status</div><div><%= norm.meta.paymentStatus %></div>
        <% if (raw.paidAt) { %><div>Paid At</div><div><%= new Date(raw.paidAt).toLocaleString() %></div><% } %>
        <% if (raw.payment && raw.payment.transactionId) { %><div>Transaction ID</div><div><code><%= raw.payment.transactionId %></code></div><% } %>
        <% if (raw.payment && raw.payment.razorpayOrderId) { %><div>Razorpay Order</div><div><code><%= raw.payment.razorpayOrderId %></code></div><% } %>
        <% if (raw.payment && raw.payment.razorpayPaymentId) { %><div>Razorpay Payment</div><div><code><%= raw.payment.razorpayPaymentId %></code></div><% } %>
      </div>
    </div>

    <!-- Items -->
    <div class="section">
      <div class="section-hd">Items</div>
      <div class="section-bd">
        <table>
          <thead>
            <tr>
              <th style="width:52%">Description</th>
              <th style="width:16%">Unit Price</th>
              <th style="width:16%">Qty</th>
              <th style="width:16%">Amount</th>
            </tr>
          </thead>
          <tbody>
            <% norm.items.forEach((it, idx) => {
                 const line = (raw.orderedItems && raw.orderedItems[idx]) || {};
                 const pstatus = (line.productStatus || 'active').toLowerCase();
                 const reason = line.cancelReason || line.returnReason || '';
            %>
              <tr>
                <td>
                  <div style="font-weight:600"><%= it.name %></div>
                  <% if (it.color) { %><div class="muted">Color: <%= it.color %></div><% } %>
                  <% if (pstatus !== 'active') { %>
                    <div class="muted" style="font-size:12px">Line status: <%= pstatus %> <% if (reason){ %> – <%= reason %><% } %></div>
                  <% } %>
                </td>
                <td>₹<%= it.unit %></td>
                <td><%= it.qty %></td>
                <td>₹<%= it.total %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>

        <div class="sum" style="margin-top:10px">
          <table>
            <tr><td>Subtotal</td><td style="text-align:right">₹<%= norm.totals.subtotal %></td></tr>
            <tr><td>Discount</td><td style="text-align:right">- ₹<%= norm.totals.discount %></td></tr>
            <tr><td>Shipping</td><td style="text-align:right"><%= norm.totals.shipping ? '₹'+norm.totals.shipping : 'Free' %></td></tr>
            <tr><td>Tax</td><td style="text-align:right">₹<%= norm.totals.tax %></td></tr>
            <tr class="tot"><td>Total</td><td style="text-align:right"><strong>₹<%= norm.totals.grand %></strong></td></tr>
          </table>
        </div>

        <div class="muted" style="margin-top:12px;font-size:12px">
          <em>Note:</em> This is a system-generated invoice. Prices include applicable taxes unless stated otherwise.
        </div>
      </div>
    </div>
  </div>
</body>
</html>
