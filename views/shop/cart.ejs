<%- include('../partials/header', { active: 'cart', pageTitle: 'Cart' }) %>

<!-- If your template already brings FA via header, you can remove this line -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<div class="cart-table-area section-padding-100">
  <div class="container-fluid">
    <div class="row">
      <!-- Left: items -->
      <div class="col-12 col-lg-8">
        <div class="cart-title mt-50">
          <h2>Shopping Cart</h2>
        </div>

        <div class="cart-table clearfix">
          <table class="table table-responsive">
            <thead>
              <tr>
                <th></th>
                <th>Name</th>
                <th>Price</th>
                <th>Quantity</th>
              </tr>
            </thead>

            <tbody>
              <% if (data && data.length) { %>
                <% data.forEach(function(item, idx){ 
                     const p = item.productDetails || {};
                     const img = (Array.isArray(p.productImage) && p.productImage[0]) ? p.productImage[0] : 'img/bg-img/default.jpg';
                     const price = (typeof p.salePrice === 'number' && p.salePrice > 0) ? p.salePrice : (p.regularPrice || 0);
                     const qtyId = 'qty' + idx; 
                %>
                  <tr>
                    <!-- Product image -->
                    <td class="cart_product_img">
                      <a href="/product/<%= p._id || item.productId %>">
                        <img src="/public/<%= img %>" alt="<%= p.productName || 'Product' %>">
                      </a>
                    </td>

                    <!-- Name + small actions -->
                    <td class="cart_product_desc">
                      <h5 style="margin-bottom:6px;"><%= p.productName %></h5>
                      <% if (item.selectedColor) { %>
                        <small class="text-muted">Color: <%= item.selectedColor %></small><br/>
                      <% } %>
                      <form action="/cart/remove" method="POST" style="display:inline-block; margin-top:6px;">
                        <input type="hidden" name="itemId" value="<%= item.itemId %>">
                        <button type="submit" class="btn btn-link p-0" style="color:#e3342f; text-decoration:none;">
                          <i class="fa fa-trash-alt"></i> Remove
                        </button>
                      </form>
                    </td>

                    <!-- Unit price -->
                    <td class="price">
                      <span>₹<%= price %></span>
                    </td>

                    <!-- Quantity (minus / input / plus) + inline Update -->
                    <td class="qty">
                      <div class="qty-btn d-flex">
                        <p style="margin-right:10px;">Qty</p>
                        <div class="quantity">
                          <span class="qty-minus"
                                onclick="(function(){var el=document.getElementById('<%= qtyId %>'); var v=parseInt(el.value,10)||1; if(v>1){el.stepDown();}})(); return false;">
                            <i class="fa fa-minus" aria-hidden="true"></i>
                          </span>

                          <form action="/cart/update" method="POST" class="d-inline" style="display:inline;">
                            <input type="hidden" name="itemId" value="<%= item.itemId %>">
                            <input type="number"
                                   class="qty-text"
                                   id="<%= qtyId %>"
                                   step="1"
                                   min="1"
                                   max="300"
                                   name="quantity"
                                   value="<%= item.quantity %>">
                            <button type="submit" class="btn btn-link p-0" style="margin-left:8px;">Update</button>
                          </form>

                          <span class="qty-plus"
                                onclick="(function(){var el=document.getElementById('<%= qtyId %>'); el.stepUp();})(); return false;">
                            <i class="fa fa-plus" aria-hidden="true"></i>
                          </span>
                        </div>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="4" class="text-center">
                    Your cart is empty.
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Right: summary -->
      <div class="col-12 col-lg-4">
        <div class="cart-summary">
          <h5>Cart Total</h5>

          <% 
            const subtotal = (data || []).reduce((sum, i) => {
              const p = i.productDetails || {};
              const pr = (typeof p.salePrice === 'number' && p.salePrice > 0) ? p.salePrice : (p.regularPrice || 0);
              return sum + pr * (i.quantity || 1);
            }, 0);

            // Delivery rule (match whatever you want; you previously used flat 49)
            const deliveryFee = subtotal >= 999 ? 0 : 49;
            const total = subtotal + deliveryFee;
          %>

          <ul class="summary-table">
            <li><span>subtotal:</span> <span>₹<%= subtotal %></span></li>
            <li><span>delivery:</span> <span><%= deliveryFee === 0 ? 'Free' : ('₹' + deliveryFee) %></span></li>
            <li><span>total:</span> <span>₹<%= total %></span></li>
          </ul>

          <div class="cart-btn mt-100">
            <form action="/checkout" method="GET">
              <button type="submit" class="btn amado-btn w-100">
                Checkout
              </button>
            </form>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
</div>
<!-- ##### Main Content Wrapper End ##### -->

<!-- ##### Newsletter Area Start ##### -->
<section class="newsletter-area section-padding-100-0">
  <div class="container">
    <div class="row align-items-center">
      <!-- Newsletter Text -->
      <div class="col-12 col-lg-6 col-xl-7">
        <div class="newsletter-text mb-100">
          <h2>Subscribe for a <span>25% Discount</span></h2>
          <p>Nulla ac convallis lorem, eget euismod nisl. Donec in libero sit amet mi vulputate consectetur. Donec auctor interdum purus, ac finibus massa bibendum nec.</p>
        </div>
      </div>
      <!-- Newsletter Form -->
      <div class="col-12 col-lg-6 col-xl-5">
        <div class="newsletter-form mb-100">
          <form action="#" method="post">
            <input type="email" name="email" class="nl-email" placeholder="Your E-mail">
            <input type="submit" value="Subscribe">
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<%- include('../partials/footer') %>
