<%- include('../partials/header', { active: 'Details', pageTitle: product.productName }) %>
<style>
  /* --- General page improvements --- */
  .single-product-area { padding: 40px 0; }

  /* Breadcrumb */
  .breadcrumb { background: transparent; margin-bottom: 1rem; }

  /* --- Product Media (Carousel) --- */
  .single_product_thumb .carousel-inner {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,.08);
    background: #f8f9fa;
  }
  .single_product_thumb .carousel-inner .carousel-item {
    height: 520px; /* fixed standard height for main image */
  }
  .single_product_thumb img {
    object-fit: cover;
    width: 100%;
    height: 100%;
    display: block;
  }
  .carousel-indicators li {
    width: 70px;
    height: 70px;
    border-radius: 8px;
    background-size: cover;
    background-position: center;
    margin: 5px;
    border: 2px solid transparent;
    cursor: pointer;
  }
  .carousel-indicators .active {
    border-color: #28a745;
  }

  /* --- Product Info --- */
  .single_product_desc {
    background: #fff;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0,0,0,.05);
  }
  .product-meta-data .product-price {
    font-size: 1.6rem;
    font-weight: 700;
    color: #222;
  }
  .product-meta-data h6 {
    font-weight: 600;
    font-size: 1.2rem;
  }

  .avaibility {
    font-size: 0.95rem;
    font-weight: 500;
  }
  .avaibility i {
    margin-right: 4px;
  }

  /* Wishlist Button */
  #wishlistBtn {
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,.1);
  }

  /* Quantity */
  .quantity {
    display: flex;
    align-items: center;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
  }
  .quantity input {
    border: none;
    text-align: center;
    width: 60px;
  }
  .quantity span {
    padding: 8px 12px;
    cursor: pointer;
    user-select: none;
    background: #f8f9fa;
  }
  .quantity span:hover {
    background: #e9ecef;
  }

  /* Tabs */
  .tabs button {
    border-radius: 20px;
  }
  #tab-desc, #tab-details, #tab-reviews {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 12px;
  }

  /* --- Related Products --- */
  .product-card {
    background: #fff;
    border-radius: 16px;
    overflow: hidden;
    transition: all .2s ease-in-out;
    box-shadow: 0 2px 8px rgba(0,0,0,.06);
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  .product-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 16px rgba(0,0,0,.1);
  }
  .product-img-wrapper {
    position: relative;
    background: #f8f9fa;
    height: 220px; /* standard card image height */
    overflow: hidden;
  }
  .product-img-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .product-card h6 {
    font-weight: 600;
    font-size: 1rem;
    margin: 12px;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
  }
  .product-card div {
    margin: 0 12px 12px;
    font-weight: 600;
    color: #222;
  }
  .product-card span {
    font-size: 0.9rem;
    color: #888;
    margin-left: 6px;
  }

  /* Wishlist mini button */
  .js-wish {
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,.1);
  }
  .js-wish i {
    font-size: 16px;
  }

  /* --- Responsive --- */
  @media (max-width: 767.98px) {
    .single_product_desc { margin-top: 20px; padding: 16px; }
    .product-meta-data .product-price { font-size: 1.3rem; }
    .product-card h6 { font-size: 0.95rem; }
    .single_product_thumb .carousel-inner .carousel-item { height: 360px; }
  }
</style>

<div class="single-product-area section-padding-100 clearfix">
  <div class="container-fluid">

    <!-- Breadcrumb (optional: make dynamic if you want) -->
    <div class="row">
      <div class="col-12">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mt-50">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
            <li class="breadcrumb-item active" aria-current="page"><%= product.productName %></li>
          </ol>
        </nav>
      </div>
    </div>

    <div class="row">
      <!-- Images -->
      <div class="col-12 col-lg-7">
        <div class="single_product_thumb">
          <div id="product_details_slider" class="carousel slide" data-ride="carousel">
            <!-- Indicators -->
            <ol class="carousel-indicators">
              <% (product.productImage || []).forEach(function(img, i){ %>
                <li class="<%= i === 0 ? 'active' : '' %>"
                    data-target="#product_details_slider"
                    data-slide-to="<%= i %>"
                    style="background-image: url(<%= '/public' + img %>);">
                </li>
              <% }) %>
            </ol>
            <!-- Slides -->
            <div class="carousel-inner">
              <% (product.productImage || []).forEach(function(img, i){ %>
                <div class="carousel-item <%= i === 0 ? 'active' : '' %>">
                  <a class="gallery_img" href="<%= '/public' + img %>">
                    <img class="d-block w-100" src="<%= '/public' + img %>" alt="<%= product.productName %>">
                  </a>
                </div>
              <% }) %>

              <% if (!product.productImage || product.productImage.length === 0) { %>
                <div class="carousel-item active">
                  <img class="d-block w-100" src="https://images.unsplash.com/photo-1519710164239-da123dc03ef4?q=80&w=1200" alt="No image">
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Info -->
      <div class="col-12 col-lg-5">
        <div class="single_product_desc">
          <div class="product-meta-data">
            <div class="line"></div>

            <p class="product-price">
              ₹<%= (product.salePrice || product.regularPrice).toLocaleString('en-IN') %>
              <% if (product.salePrice && product.salePrice < product.regularPrice) { %>
                <span style="text-decoration: line-through; margin-left:8px; color:#888;">
                  ₹<%= product.regularPrice.toLocaleString('en-IN') %>
                </span>
                <span class="badge badge-success ml-2">
                  <%= Math.round(((product.regularPrice - product.salePrice)/product.regularPrice)*100) %>% off
                </span>
              <% } %>
            </p>

            <div class="d-flex align-items-center justify-content-between">
              <h6 class="mb-0"><%= product.productName %></h6>

              <!-- ♥ wishlist toggle -->
              <button id="wishlistBtn"
                      class="btn btn-light"
                      data-id="<%= product._id %>"
                      data-wished="<%= isWished ? '1' : '0' %>"
                      title="<%= isWished ? 'Remove from wishlist' : 'Add to wishlist' %>">
                <i class="<%= isWished ? 'fa fa-heart text-danger' : 'fa fa-heart-o' %>"></i>
              </button>
            </div>

            <!-- Rating (static placeholder) -->
            <div class="ratings-review mb-15 d-flex align-items-center justify-content-between">
              <div class="ratings">
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star-o" aria-hidden="true"></i>
              </div>
              <div class="review">
                <a href="#reviews">Write A Review</a>
              </div>
            </div>

            <p class="avaibility">
              <i class="fa fa-circle" style="color:<%= product.quantity > 0 ? '#28a745' : '#dc3545' %>"></i>
              <%= product.quantity > 0 ? ' In Stock' : ' Out of Stock' %>
            </p>
          </div>

          <!-- Short overview -->
          <div class="short_overview my-5">
            <p><%= product.description || '' %></p>
          </div>

          <!-- Color Variants -->
          <% if ((variants || []).length) { %>
            <div class="mb-3">
              <label><strong>Available Colors:</strong></label>
              <div>
                <% variants.forEach(function(v){ %>
                  <a href="/product/<%= v._id %>" class="mr-1" title="<%= v.color %>"
                     style="display:inline-block;width:22px;height:22px;border-radius:50%;
                            background:<%= v.color %>; border:1px solid #ccc;"></a>
                <% }) %>
              </div>
            </div>
          <% } %>

          <!-- Qty + Add to cart -->
          <form class="cart clearfix" action="/cart/add/<%= product._id %>" method="POST">
            <div class="cart-btn d-flex mb-50">
              <p>Qty</p>
              <div class="quantity">
                <span class="qty-minus" onclick="var e=document.getElementById('qty'); var v=e.value; if(!isNaN(v)&&v>1) e.value--; return false;">
                  <i class="fa fa-caret-down" aria-hidden="true"></i>
                </span>
                <input type="number" class="qty-text" id="qty" step="1" min="1" max="300" name="quantity" value="1">
                <span class="qty-plus" onclick="var e=document.getElementById('qty'); var v=e.value; if(!isNaN(v)) e.value++; return false;">
                  <i class="fa fa-caret-up" aria-hidden="true"></i>
                </span>
              </div>
            </div>
            <button type="submit" name="addtocart" value="1" class="btn amado-btn">Add to cart</button>
          </form>

          <!-- Details / Reviews -->
          <div class="tabs mt-4">
            <button class="btn btn-sm btn-outline-secondary mr-2" onclick="toggleTab('desc')">Description</button>
            <button class="btn btn-sm btn-outline-secondary mr-2" onclick="toggleTab('details')">Details</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleTab('reviews')">Reviews</button>
          </div>
          <div id="tab-desc" class="mt-3"><%= product.description || '—' %></div>
          <div id="tab-details" class="mt-3" style="display:none;">
            Category: <%= product.category ? product.category.name : 'N/A' %><br>
            SubCategory: <%= product.subcategory ? product.subcategory.name : 'N/A' %><br>
            Color: <%= product.color %>
          </div>
          <div id="tab-reviews" class="mt-3" style="display:none;">
            <% if (product.reviews && product.reviews.length) { %>
              <% product.reviews.forEach(function(r){ %>
                <p>⭐ <%= r.rating %>/5 — <%= r.comment %></p>
              <% }) %>
            <% } else { %>
              <p>No reviews yet.</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Related -->
    <div class="row mt-5">
      <div class="col-12">
        <h5>Related Products</h5>
      </div>
      <% (relatedProducts || []).forEach(function(rp){ %>
        <div class="col-md-3 col-sm-6 mb-4">
          <div class="product-card">
            <div class="product-img-wrapper" style="position:relative;">
              <a href="/product/<%= rp._id %>">
                <img src="<%= '/public' + (rp.productImage?.[0] || '') %>"
                     onerror="this.src='https://images.unsplash.com/photo-1519710164239-da123dc03ef4?q=80&w=600';"
                     class="img-fluid" alt="<%- rp.productName %>">
              </a>
              <button class="btn btn-sm btn-light js-wish"
                      data-id="<%= rp._id %>"
                      style="position:absolute; top:8px; right:8px;">
                <i class="fa fa-heart-o"></i>
              </button>
            </div>
            <h6 class="mt-2 mb-1"><%= rp.productName %></h6>
            <div>
              ₹<%= (rp.salePrice || rp.regularPrice).toLocaleString('en-IN') %>
              <% if (rp.salePrice && rp.salePrice < rp.regularPrice) { %>
                <span style="text-decoration:line-through; color:#888;">
                  ₹<%= rp.regularPrice.toLocaleString('en-IN') %>
                </span>
              <% } %>
            </div>
          </div>
        </div>
      <% }) %>
    </div>

  </div>
</div>

<script>
  function toggleTab(which) {
    ["desc","details","reviews"].forEach(function(k){
      document.getElementById("tab-"+k).style.display = (k === which) ? "block" : "none";
    });
  }

  // Product page heart
  (function () {
    const btn = document.getElementById('wishlistBtn');
    if (!btn) return;
    const icon = btn.querySelector('i');
    const pid = btn.dataset.id;

    btn.addEventListener('click', async () => {
      const wished = btn.dataset.wished === '1';
      const method = wished ? 'DELETE' : 'POST';
      try {
        const res = await fetch(`/wishlist/${pid}`, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest' // so protect returns 401 JSON
          }
        });

        if (res.status === 401) {
          const next = encodeURIComponent(window.location.pathname);
          window.location.href = `/auth/login?next=${next}`;
          return;
        }

        const data = await res.json().catch(() => ({}));
        if (data && data.success) {
          btn.dataset.wished = wished ? '0' : '1';
          icon.className = wished ? 'fa fa-heart-o' : 'fa fa-heart text-danger';
          btn.title = wished ? 'Add to wishlist' : 'Remove from wishlist';
        } else {
          alert((data && data.message) || 'Could not update wishlist');
        }
      } catch (e) {
        console.error(e);
        alert('Could not update wishlist');
      }
    });

    // Related list mini-hearts (optimistic)
    document.addEventListener('click', async (e) => {
      const t = e.target.closest('.js-wish');
      if (!t) return;
      const id = t.dataset.id;
      const i = t.querySelector('i');
      const adding = i.classList.contains('fa-heart-o');
      try {
        const res = await fetch(`/wishlist/${id}`, {
          method: adding ? 'POST' : 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        if (res.status === 401) {
          const next = encodeURIComponent(window.location.pathname);
          window.location.href = `/auth/login?next=${next}`;
          return;
        }
        const data = await res.json().catch(() => ({}));
        if (data && data.success) {
          i.className = adding ? 'fa fa-heart text-danger' : 'fa fa-heart-o';
        }
      } catch {}
    });
  })();
</script>

<%- include('../partials/footer') %>
