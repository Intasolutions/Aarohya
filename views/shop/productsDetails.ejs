<%- include('../partials/header', { active: 'Details', pageTitle: product.productName }) %>

<div class="single-product-area section-padding-100 clearfix">
  <div class="container-fluid">

    <!-- Breadcrumb (optional: make dynamic if you want) -->
    <div class="row">
      <div class="col-12">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mt-50">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
            <li class="breadcrumb-item active" aria-current="page"><%= product.productName %></li>
          </ol>
        </nav>
      </div>
    </div>

    <div class="row">
      <!-- Images -->
      <div class="col-12 col-lg-7">
        <div class="single_product_thumb">
          <div id="product_details_slider" class="carousel slide" data-ride="carousel">
            <!-- Indicators -->
            <ol class="carousel-indicators">
              <% (product.productImage || []).forEach(function(img, i){ %>
                <li class="<%= i === 0 ? 'active' : '' %>"
                    data-target="#product_details_slider"
                    data-slide-to="<%= i %>"
                    style="background-image: url(<%= '/public' + img %>);">
                </li>
              <% }) %>
            </ol>
            <!-- Slides -->
            <div class="carousel-inner">
              <% (product.productImage || []).forEach(function(img, i){ %>
                <div class="carousel-item <%= i === 0 ? 'active' : '' %>">
                  <a class="gallery_img" href="<%= '/public' + img %>">
                    <img class="d-block w-100" src="<%= '/public' + img %>" alt="<%= product.productName %>">
                  </a>
                </div>
              <% }) %>

              <% if (!product.productImage || product.productImage.length === 0) { %>
                <div class="carousel-item active">
                  <img class="d-block w-100" src="https://images.unsplash.com/photo-1519710164239-da123dc03ef4?q=80&w=1200" alt="No image">
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Info -->
      <div class="col-12 col-lg-5">
        <div class="single_product_desc">
          <div class="product-meta-data">
            <div class="line"></div>

            <p class="product-price">
              ₹<%= (product.salePrice || product.regularPrice).toLocaleString('en-IN') %>
              <% if (product.salePrice && product.salePrice < product.regularPrice) { %>
                <span style="text-decoration: line-through; margin-left:8px; color:#888;">
                  ₹<%= product.regularPrice.toLocaleString('en-IN') %>
                </span>
                <span class="badge badge-success ml-2">
                  <%= Math.round(((product.regularPrice - product.salePrice)/product.regularPrice)*100) %>% off
                </span>
              <% } %>
            </p>

            <div class="d-flex align-items-center justify-content-between">
              <h6 class="mb-0"><%= product.productName %></h6>

              <!-- ♥ wishlist toggle -->
              <button id="wishlistBtn"
                      class="btn btn-light"
                      data-id="<%= product._id %>"
                      data-wished="<%= isWished ? '1' : '0' %>"
                      title="<%= isWished ? 'Remove from wishlist' : 'Add to wishlist' %>">
                <i class="<%= isWished ? 'fa fa-heart text-danger' : 'fa fa-heart-o' %>"></i>
              </button>
            </div>

            <!-- Rating (static placeholder) -->
            <div class="ratings-review mb-15 d-flex align-items-center justify-content-between">
              <div class="ratings">
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star-o" aria-hidden="true"></i>
              </div>
              <div class="review">
                <a href="#reviews">Write A Review</a>
              </div>
            </div>

            <p class="avaibility">
              <i class="fa fa-circle" style="color:<%= product.quantity > 0 ? '#28a745' : '#dc3545' %>"></i>
              <%= product.quantity > 0 ? ' In Stock' : ' Out of Stock' %>
            </p>
          </div>

          <!-- Short overview -->
          <div class="short_overview my-5">
            <p><%= product.description || '' %></p>
          </div>

          <!-- Color Variants -->
          <% if ((variants || []).length) { %>
            <div class="mb-3">
              <label><strong>Available Colors:</strong></label>
              <div>
                <% variants.forEach(function(v){ %>
                  <a href="/product/<%= v._id %>" class="mr-1" title="<%= v.color %>"
                     style="display:inline-block;width:22px;height:22px;border-radius:50%;
                            background:<%= v.color %>; border:1px solid #ccc;"></a>
                <% }) %>
              </div>
            </div>
          <% } %>

          <!-- Qty + Add to cart -->
          <form class="cart clearfix" action="/cart/add/<%= product._id %>" method="POST">
            <div class="cart-btn d-flex mb-50">
              <p>Qty</p>
              <div class="quantity">
                <span class="qty-minus" onclick="var e=document.getElementById('qty'); var v=e.value; if(!isNaN(v)&&v>1) e.value--; return false;">
                  <i class="fa fa-caret-down" aria-hidden="true"></i>
                </span>
                <input type="number" class="qty-text" id="qty" step="1" min="1" max="300" name="quantity" value="1">
                <span class="qty-plus" onclick="var e=document.getElementById('qty'); var v=e.value; if(!isNaN(v)) e.value++; return false;">
                  <i class="fa fa-caret-up" aria-hidden="true"></i>
                </span>
              </div>
            </div>
            <button type="submit" name="addtocart" value="1" class="btn amado-btn">Add to cart</button>
          </form>

          <!-- Details / Reviews -->
          <div class="tabs mt-4">
            <button class="btn btn-sm btn-outline-secondary mr-2" onclick="toggleTab('desc')">Description</button>
            <button class="btn btn-sm btn-outline-secondary mr-2" onclick="toggleTab('details')">Details</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleTab('reviews')">Reviews</button>
          </div>
          <div id="tab-desc" class="mt-3"><%= product.description || '—' %></div>
          <div id="tab-details" class="mt-3" style="display:none;">
            Category: <%= product.category ? product.category.name : 'N/A' %><br>
            SubCategory: <%= product.subcategory ? product.subcategory.name : 'N/A' %><br>
            Color: <%= product.color %>
          </div>
          <div id="tab-reviews" class="mt-3" style="display:none;">
            <% if (product.reviews && product.reviews.length) { %>
              <% product.reviews.forEach(function(r){ %>
                <p>⭐ <%= r.rating %>/5 — <%= r.comment %></p>
              <% }) %>
            <% } else { %>
              <p>No reviews yet.</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Related -->
    <div class="row mt-5">
      <div class="col-12">
        <h5>Related Products</h5>
      </div>
      <% (relatedProducts || []).forEach(function(rp){ %>
        <div class="col-md-3 col-sm-6 mb-4">
          <div class="product-card">
            <div class="product-img-wrapper" style="position:relative;">
              <a href="/product/<%= rp._id %>">
                <img src="<%= '/public' + (rp.productImage?.[0] || '') %>"
                     onerror="this.src='https://images.unsplash.com/photo-1519710164239-da123dc03ef4?q=80&w=600';"
                     class="img-fluid" alt="<%- rp.productName %>">
              </a>
              <button class="btn btn-sm btn-light js-wish"
                      data-id="<%= rp._id %>"
                      style="position:absolute; top:8px; right:8px;">
                <i class="fa fa-heart-o"></i>
              </button>
            </div>
            <h6 class="mt-2 mb-1"><%= rp.productName %></h6>
            <div>
              ₹<%= (rp.salePrice || rp.regularPrice).toLocaleString('en-IN') %>
              <% if (rp.salePrice && rp.salePrice < rp.regularPrice) { %>
                <span style="text-decoration:line-through; color:#888;">
                  ₹<%= rp.regularPrice.toLocaleString('en-IN') %>
                </span>
              <% } %>
            </div>
          </div>
        </div>
      <% }) %>
    </div>

  </div>
</div>

<script>
  function toggleTab(which) {
    ["desc","details","reviews"].forEach(function(k){
      document.getElementById("tab-"+k).style.display = (k === which) ? "block" : "none";
    });
  }

  // Product page heart
  (function () {
    const btn = document.getElementById('wishlistBtn');
    if (!btn) return;
    const icon = btn.querySelector('i');
    const pid = btn.dataset.id;

    btn.addEventListener('click', async () => {
      const wished = btn.dataset.wished === '1';
      const method = wished ? 'DELETE' : 'POST';
      try {
        const res = await fetch(`/wishlist/${pid}`, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest' // so protect returns 401 JSON
          }
        });

        if (res.status === 401) {
          const next = encodeURIComponent(window.location.pathname);
          window.location.href = `/auth/login?next=${next}`;
          return;
        }

        const data = await res.json().catch(() => ({}));
        if (data && data.success) {
          btn.dataset.wished = wished ? '0' : '1';
          icon.className = wished ? 'fa fa-heart-o' : 'fa fa-heart text-danger';
          btn.title = wished ? 'Add to wishlist' : 'Remove from wishlist';
        } else {
          alert((data && data.message) || 'Could not update wishlist');
        }
      } catch (e) {
        console.error(e);
        alert('Could not update wishlist');
      }
    });

    // Related list mini-hearts (optimistic)
    document.addEventListener('click', async (e) => {
      const t = e.target.closest('.js-wish');
      if (!t) return;
      const id = t.dataset.id;
      const i = t.querySelector('i');
      const adding = i.classList.contains('fa-heart-o');
      try {
        const res = await fetch(`/wishlist/${id}`, {
          method: adding ? 'POST' : 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        if (res.status === 401) {
          const next = encodeURIComponent(window.location.pathname);
          window.location.href = `/auth/login?next=${next}`;
          return;
        }
        const data = await res.json().catch(() => ({}));
        if (data && data.success) {
          i.className = adding ? 'fa fa-heart text-danger' : 'fa fa-heart-o';
        }
      } catch {}
    });
  })();
</script>

<%- include('../partials/footer') %>
