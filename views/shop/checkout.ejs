
<%- include('../partials/header1') %>
  <!-- Content -->
  <main>
    <!-- Benefits strip -->
    <!-- <div class="chk-benefits">
      <div><i class="fa fa-shield"></i> Secure payments</div>
      <div><i class="fa fa-truck"></i> Fast, tracked delivery</div>
      <div><i class="fa fa-undo"></i> Easy returns</div>
    </div> -->

    <div class="chk-container">
      <div class="chk-grid">
        <!-- LEFT -->
        <section class="chk-card" aria-labelledby="sec-checkout">
          <header class="blk-head" style="margin-bottom:14px">
            <div>
              <h1 id="sec-checkout">Checkout</h1>
              <p class="muted" style="margin:0">Add your shipping details and choose a payment method</p>
            </div>
            <ul class="chk-stepper" aria-label="Steps">
              <li class="active">Address</li>
              <li>Payment</li>
              <li>Review</li>
            </ul>
          </header>

          <!-- Issues -->
          <div id="checkoutIssues" class="chk-issues" role="alert" aria-live="polite"></div>

          <form id="checkoutForm" autocomplete="on" novalidate>
            <!-- Address -->
            <div class="blk">
              <div class="blk-head">
                <h2>Shipping Address</h2>
                <div class="mode-tabs" role="radiogroup" aria-label="Address mode">
                  <label class="mode-tab">
                    <input type="radio" name="addrMode" value="saved" id="addrSaved" checked />
                    <i class="fa fa-bookmark"></i> Use saved
                  </label>
                  <label class="mode-tab">
                    <input type="radio" name="addrMode" value="new" id="addrNew" />
                    <i class="fa fa-plus"></i> New address
                  </label>
                </div>
              </div>

              <div id="savedAddrWrap" class="addr-list" aria-label="Saved addresses">
                <% if (addresses && addresses.length) { %>
                  <% addresses.forEach(function(a, idx){ %>
                    <label class="addr-tile <%= idx === 0 ? 'active':'' %>">
                      <input
                        aria-label="Use <%= a.addressType %> address"
                        type="radio"
                        name="addressId"
                        value="<%= a._id %>"
                        <%= idx === 0 ? 'checked':'' %> />
                      <div>
                        <div class="addr-head">
                          <strong><%= a.name %></strong>
                          <span class="badge"><%= a.addressType %></span>
                        </div>
                        <small class="muted">
                          <%= a.apartment %>, <%= a.building %>, <%= a.street %>, <%= a.city %>, <%= a.state %> - <%= a.zip %>, <%= a.country %><br/>
                          Phone: <%= a.phone %> <%= a.altPhone ? (' / ' + a.altPhone) : '' %>
                        </small>
                      </div>
                      <i class="tick fa fa-check"></i>
                    </label>
                  <% }) %>
                <% } else { %>
                  <div class="addr-empty">
                    <i class="fa fa-info-circle"></i>
                    <span>No saved addresses. Please add a new one below.</span>
                  </div>
                  <script>window.__forceNewAddress = true;</script>
                <% } %>
              </div>

              <!-- New address -->
              <div id="newAddrWrap" class="addr-inline" style="display:none;margin-top:12px">
                <div class="row">
                  <div class="col-md-4 fld">
                    <label class="muted" for="addressType">Type</label>
                    <select class="form-control" name="addressType" id="addressType" required>
                      <option value="Home">Home</option>
                      <option value="Work">Work</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>

                  <div class="col-md-8 fld">
                    <label class="muted" for="name">Full name</label>
                    <input type="text" class="form-control" name="name" id="name" required />
                  </div>

                  <div class="col-md-6 fld">
                    <label class="muted" for="apartment">Apartment / Flat No</label>
                    <input type="text" class="form-control" name="apartment" id="apartment" required />
                  </div>

                  <div class="col-md-6 fld">
                    <label class="muted" for="building">Building / House Name</label>
                    <input type="text" class="form-control" name="building" id="building" required />
                  </div>

                  <div class="col-md-6 fld">
                    <label class="muted" for="street">Street / Area</label>
                    <input type="text" class="form-control" name="street" id="street" required />
                  </div>

                  <div class="col-md-6 fld">
                    <label class="muted" for="landmark">Landmark (optional)</label>
                    <input type="text" class="form-control" name="landmark" id="landmark" />
                  </div>

                  <div class="col-md-4 fld">
                    <label class="muted" for="city">City</label>
                    <input type="text" class="form-control" name="city" id="city" required />
                  </div>

                  <div class="col-md-4 fld">
                    <label class="muted" for="state">State</label>
                    <input type="text" class="form-control" name="state" id="state" required />
                  </div>

                  <div class="col-md-4 fld">
                    <label class="muted" for="country">Country</label>
                    <input type="text" class="form-control" name="country" id="country" value="India" required />
                  </div>

                  <div class="col-md-4 fld">
                    <label class="muted" for="zip">PIN / ZIP</label>
                    <input type="text" inputmode="numeric" pattern="[0-9]{6}" class="form-control" name="zip" id="zip" required />
                  </div>

                  <div class="col-md-4 fld">
                    <label class="muted" for="phone">Phone</label>
                    <input type="tel" inputmode="tel" class="form-control" name="phone" id="phone" required />
                  </div>

                  <div class="col-md-4 fld">
                    <label class="muted" for="altPhone">Alternate Phone (optional)</label>
                    <input type="tel" inputmode="tel" class="form-control" name="altPhone" id="altPhone" />
                  </div>
                </div>
              </div>
            </div>

            <!-- Note -->
            <div class="blk">
              <div class="blk-head">
                <h2>Order Note</h2>
              </div>
              <label class="fld">
                <span class="sr-only">Add a note</span>
                <textarea name="note" class="form-control" rows="3" placeholder="Leave a note about your order (optional)"></textarea>
              </label>
            </div>

            <!-- Payment -->
            <div class="blk">
              <div class="blk-head">
                <h2>Payment</h2>
              </div>
              <div class="radio-list" role="radiogroup" aria-label="Payment method">
                <label class="radio-tile">
                  <input type="radio" name="paymentMethod" id="pay_cod" value="cod" checked />
                  <span class="title">Cash on Delivery</span>
                  <span class="sub">Pay in cash when the order arrives</span>
                </label>

                <% if (paymentKeyId) { %>
                <label class="radio-tile">
                  <input type="radio" name="paymentMethod" id="pay_rzp" value="razorpay" />
                  <span class="title">Online Payment</span>
                  <span class="sub">UPI, cards, net-banking</span>
                  <div class="pay-logos" aria-hidden="true">
                    <img src="/public/img/core-img/paypal.png" alt="">
                  </div>
                </label>
                <% } %>
              </div>
            </div>

            <div class="submit-row">
              <button id="placeOrderBtn" class="btn-primary w-full" type="submit">
                Place Order
              </button>
              <a href="/cart" class="btn-ghost">Back to cart</a>
            </div>
          </form>
        </section>

        <!-- RIGHT -->
        <aside class="chk-summary-card" aria-labelledby="order-summary">
          <div class="sum-head">
            <h3 id="order-summary">Order Summary</h3>
            <a href="/cart" class="muted small-link">Edit cart</a>
          </div>

          <div class="sum-items" role="list">
            <% if (items && items.length) { %>
              <% items.forEach(function(it){ %>
                <div class="sum-item" role="listitem">
                  <img src="<%= it.image ? ('/public/' + it.image) : '/public/img/bg-img/cart1.jpg' %>" alt="">
                  <div class="sum-info">
                    <div class="name"><%= it.productName %></div>
                    <small class="muted">Qty: <%= it.quantity %> • Color: <%= it.color %></small><br/>
                    <small class="price-each">₹<%= it.unitPrice %> each</small>
                  </div>
                  <div class="line">₹<%= it.lineTotal %></div>
                </div>
              <% }) %>
            <% } else { %>
              <p class="muted">Your cart is empty.</p>
            <% } %>
          </div>

          <ul class="summary-table">
            <li><span>Subtotal</span><span>₹<%= totals.subtotal %></span></li>
            <li><span>Discount</span><span>- ₹<%= totals.discountAmount %></span></li>
            <li><span>Shipping</span><span><%= totals.shippingFee === 0 ? 'Free' : ('₹' + totals.shippingFee) %></span></li>
            <% if (totals.taxAmount && totals.taxAmount > 0) { %>
              <li><span>Tax</span><span>₹<%= totals.taxAmount %></span></li>
            <% } %>
            <li class="total"><span>Total</span><span>₹<%= totals.grandTotal %></span></li>
          </ul>

          <ul class="trust">
            <li><i class="fa fa-lock"></i> Your data is encrypted</li>
            <li><i class="fa fa-headphones"></i> 24×7 support</li>
          </ul>
        </aside>
      </div>
    </div>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<%- include('../partials/footer1') %>