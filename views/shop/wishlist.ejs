<%- include('../partials/header', { active: 'wishlist', pageTitle: 'My Wishlist' }) %>

<link rel="stylesheet" href="/public/css/wishlist.css">

<div class="wl-wrap">
  <div class="wl-hero">
    <div>
      <div class="wl-title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 21s-7-4.438-7-10A4.5 4.5 0 0 1 12 7a4.5 4.5 0 0 1 7 4c0 5.562-7 10-7 10Z" stroke="currentColor" stroke-width="1.5"/>
        </svg>
        My Wishlist
      </div>
      <div class="wl-sub">
        <%= (wishlist && wishlist.length) ? `${wishlist.length} item${wishlist.length>1?'s':''} saved for later` : 'Nothing saved yet — let’s find you something beautiful.' %>
      </div>
    </div>
    <div class="wl-ctas">
      <a href="/shop" class="wl-btn"><i class="fa-solid fa-arrow-left"></i> Continue Shopping</a>
      <a href="/cart" class="wl-btn primary"><i class="fa-solid fa-cart-shopping"></i> Go to Cart</a>
    </div>
  </div>

  <div class="wl-toolbar">
    <div class="wl-count">
      <i class="fa-regular fa-heart"></i>
      <span><%= (wishlist && wishlist.length) ? `${wishlist.length} item${wishlist.length>1?'s':''}` : '0 items' %></span>
    </div>
    <div>
      <select class="wl-select" id="wlSort">
        <option value="new">Newest</option>
        <option value="priceLow">Price: Low to High</option>
        <option value="priceHigh">Price: High to Low</option>
        <option value="name">Name</option>
      </select>
    </div>
  </div>

  <% if (wishlist && wishlist.length) { %>
    <div class="wl-grid" id="wlGrid">
      <% wishlist.forEach(function(p){ 
          const hasOffer = typeof p.salePrice === 'number' && p.salePrice < p.regularPrice;
          const discount = hasOffer ? Math.round(((p.regularPrice - p.salePrice)/p.regularPrice)*100) : 0;
          const firstImg = (p.productImage && p.productImage.length) ? ('/public' + p.productImage[0]) : 'https://images.unsplash.com/photo-1519710164239-da123dc03ef4?q=80&w=600';
      %>
        <div class="wl-card" data-name="<%= p.productName %>" data-price="<%= hasOffer ? p.salePrice : p.regularPrice %>">
          <div class="wl-img-wrap">
            <a href="/product/<%= p._id %>">
              <img class="wl-img" src="<%= firstImg %>" alt="<%- p.productName %>" />
            </a>
            <% if (p.category || p.subcategory) { %>
              <span class="wl-badge"><%= (p.category && p.category.name) || (p.subcategory && p.subcategory.name) || 'Featured' %></span>
            <% } %>
            <div class="wl-like">
              <button class="wl-icon-btn danger js-remove" data-id="<%= p._id %>" title="Remove from wishlist">
                <i class="fa-regular fa-trash-can"></i>
              </button>
            </div>
          </div>
          <div class="wl-body">
            <a class="wl-name" href="/product/<%= p._id %>"><%- p.productName %></a>
            <div class="wl-meta">
              <% if (p.category) { %><span><%= p.category.name %></span><% } %>
              <% if (p.subcategory) { %><span class="wl-dot"></span><span><%= p.subcategory.name %></span><% } %>
            </div>
            <div class="wl-price">
              <div class="wl-price-now">₹<%= (hasOffer ? p.salePrice : p.regularPrice).toLocaleString('en-IN') %></div>
              <% if (hasOffer) { %>
                <div class="wl-price-old">₹<%= p.regularPrice.toLocaleString('en-IN') %></div>
                <span class="wl-chip-off"><%= discount %>% off</span>
              <% } %>
            </div>
            <div class="wl-actions">
              <button class="wl-add js-move-cart" data-id="<%= p._id %>">
                <i class="fa-solid fa-cart-plus"></i> Move to Cart
              </button>
              <button class="wl-remove js-remove" data-id="<%= p._id %>">
                <i class="fa-regular fa-heart"></i> Remove
              </button>
            </div>
          </div>
        </div>
      <% }) %>
    </div>

    <% if (totalPages && totalPages > 1) { %>
      <div class="wl-pager">
        <a class="wl-page <%= currentPage === 1 ? 'disabled' : '' %>" href="?page=<%= currentPage - 1 %>">Prev</a>
        <% for (let i = 1; i <= totalPages; i++) { %>
          <a class="wl-page <%= currentPage === i ? 'active' : '' %>" href="?page=<%= i %>"><%= i %></a>
        <% } %>
        <a class="wl-page <%= currentPage === totalPages ? 'disabled' : '' %>" href="?page=<%= currentPage + 1 %>">Next</a>
      </div>
    <% } %>
  <% } else { %>
    <div class="wl-empty">
      <div style="font-size:18px; font-weight:700; color:#fff; margin-bottom:8px;">Your wishlist is empty</div>
      <div style="margin-bottom:16px;">Save items you love — they’ll live here for quick access.</div>
      <a class="wl-btn primary" href="/shop"><i class="fa-solid fa-compass"></i> Explore Products</a>
    </div>
  <% } %>
</div>

<script src="/public/js/wishlist.js"></script>
<script>// /public/js/wishlist.js
(function () {
  const grid = document.getElementById("wlGrid");

  // Remove from wishlist
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".js-remove");
    if (!btn) return;
    const id = btn.dataset.id;

    try {
      const res = await fetch(`/wishlist/${id}`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest"
        }
      });

      if (res.status === 401) {
        const next = encodeURIComponent(window.location.pathname);
        window.location.href = `/auth/login?next=${next}`;
        return;
      }

      const data = await res.json().catch(() => ({}));
      if (!data.success) throw new Error(data.message || "Failed");

      // Remove card from DOM
      const card = btn.closest(".wl-card");
      if (card) card.remove();

      // Update counts / empty state
      const countEl = document.querySelector(".wl-count span");
      if (countEl) {
        const current = grid ? grid.querySelectorAll(".wl-card").length : 0;
        countEl.textContent = current ? `${current} item${current > 1 ? "s" : ""}` : "0 items";
      }
      if (!grid || !grid.querySelector(".wl-card")) {
        window.location.reload(); // simplest to reveal empty state/pager changes
      }
    } catch (err) {
      console.error(err);
      alert("Could not remove item. Please try again.");
    }
  });

  // Move to cart (server handles add; we then remove from wishlist)
  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".js-move-cart");
    if (!btn) return;
    const id = btn.dataset.id;

    try {
      // If you have a JSON cart API, call it here.
      // For now, redirect so your existing POST route handles it:
      window.location.href = `/cart/add/${id}?from=wishlist`;
    } catch (err) {
      console.error(err);
      alert("Could not move item to cart.");
    }
  });

  // Optional: sort client-side
  const sortSel = document.getElementById("wlSort");
  if (sortSel && grid) {
    sortSel.addEventListener("change", () => {
      const cards = Array.from(grid.querySelectorAll(".wl-card"));
      const v = sortSel.value;

      cards.sort((a, b) => {
        if (v === "name") {
          return a.dataset.name.localeCompare(b.dataset.name);
        }
        if (v === "priceLow") {
          return Number(a.dataset.price) - Number(b.dataset.price);
        }
        if (v === "priceHigh") {
          return Number(b.dataset.price) - Number(a.dataset.price);
        }
        // newest: leave as-is (server order)
        return 0;
      });

      cards.forEach((c) => grid.appendChild(c));
    });
  }
})();
</script>
<%- include('../partials/footer') %>
